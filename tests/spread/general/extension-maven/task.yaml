summary: maven extension test

environment:
  ROCKCRAFT_ENABLE_EXPERIMENTAL_EXTENSIONS: "true"

execute: |

  run_rockcraft init --name example-maven --profile maven
  run_rockcraft pack

  test -f example-maven_0.1_amd64.rock

  # Ensure docker does not have this container image
  docker rmi --force example-maven
  # Install container
  sudo rockcraft.skopeo --insecure-policy copy oci-archive:example-maven_0.1_amd64.rock docker-daemon:example-maven:latest
  # Ensure container exists
  docker images example-maven | MATCH "example-maven"

  # ensure container doesn't exist
  docker rm -f example-maven-container

  # test the maven project is ready to run inside the container
  docker run --rm example-maven

  # test the default maven service
  docker run --name example-maven-container -d -p 8138:8000 example-maven
  retry -n 5 --wait 2 curl localhost:8138
  [ "$(curl -sw '%{http_code}' -o /dev/null localhost:8138)" == "200" ]

restore: |
  rm -f example-maven_0.1_amd64.rock
  docker rmi -f example-maven
  docker rm -f example-maven-container
